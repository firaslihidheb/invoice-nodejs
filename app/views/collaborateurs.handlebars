<script type="text/javascript" src="static/javascripts/vendor/moment.min.js"></script>
<nav class="navbar navbar-default">
    <a href="#" class="navbar-left"><img class="custom_brand_logo" src="/static/images/logo.png" alt="logo"
            style="float: left;" height="50"></a>
    <div class="container-fluid">
        <ul class="nav nav-tabs navbar-nav navbar-right">
            <li class=""><a href="/products"><i class="fa fa-th-list" aria-hidden="true"></i> Contrats</a></li>
            <li class=""><a href="/invoices"><i class="fa fa-file-text-o" aria-hidden="true"></i> Factures</a></li>
            <li class=""><a href="/customers"><i class="fa fa-users" aria-hidden="true"></i> Clients</a></li>
            <li class="active"><a href="#"><i class="fa fa-users" aria-hidden="true"></i> Collaborateurs</a></li>
            <li class="logout-root"><a href="#logout"><i class="fa fa-sign-out" aria-hidden="true"></i>Log Out</a></li>
        </ul>
    </div>
</nav>
<div class="container">
    <div class="col-md-6 ">
        <h2>Collaborateur</h2>
    </div>
    <div class="col-md-6 ">
        <div class="add_more_button add_new_user" style="width: 124px"><i class="fa fa-plus" aria-hidden="true"></i>
            Ajouter un nouveau collaborateur</div>
        <div class="remove_more_button remove_new_user" style="width: 124px; display: none"><i class="fa fa-times"
                aria-hidden="true"></i> Cancel</div>
    </div>
</div>
<div class="panel-body">
    <div class="row">
        <div class="col-md-12">

            <form id="register-form" class="add-register-form" style="display: none">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" autofocus autocomplete="current-name" name="name" id="name" tabindex="1"
                        class="form-control" placeholder="Nom" required>
                </div>
                <div class="form-group">
                    <label>Prénom </label>
                    <input type="text" autocomplete="current-last-name" name="last_name" id="last_name" tabindex="1"
                        class="form-control" placeholder="Prenom" required>
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" autocomplete="current-email" name="email" id="email" tabindex="1"
                        class="form-control" placeholder="Email Address (optional)">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" autocomplete="current-password" minlength="6" name="password" id="password"
                        tabindex="1" class="form-control" placeholder="Enter password (Min 6 digits)" required
                        title="Min 6 digits">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" autocomplete="current-password1" minlength="6" name="confirm_password"
                        id="confirm_password" tabindex="2" class="form-control"
                        placeholder="Confirm Password (Min 6 digits)" required title="Min 6 digits">
                </div>
                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" name="qualification" id="qualification" tabindex="1" class="form-control"
                        placeholder="Qualification" required>
                </div>

                <div class="form-group">
                    <label>Role</label>
                    <select required name="company_type" id="company_type" tabindex="1">
                        <option title='Select' value="0">user</option>
                        <option title='freelancer' value='1'>admin</option>
                    </select>
                </div>

                <div class="row">
                    <div class="col-sm-6 col-sm-offset-3">
                        <div style="margin-bottom: 10px; display: none;text-align: center" class="alert_user"></div>
                        <input type="submit" name="register-submit" id="register-submit"
                            class="form-control btn btn-login" value="Modifier">
                    </div>
                </div>
            </form>

            <form id="update-form" class="update-register-form" style="display: none">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" autofocus autocomplete="current-name" name="update-name" id="update-name"
                        tabindex="1" class="form-control" placeholder="Nom" required>
                </div>
                <div class="form-group">
                    <label>Prénom </label>
                    <input type="text" autocomplete="current-last-name" name="update-last_name" id="update-last_name"
                        tabindex="1" class="form-control" placeholder="Prenom" required>
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" autocomplete="current-email" name="update-email" id="update-email" tabindex="1"
                        class="form-control" placeholder="Email Address (optional)">
                </div>

                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" name="update-qualification" id="update-qualification" tabindex="1"
                        class="form-control" placeholder="Qualification" required>
                </div>

                <div class="form-group">
                    <label>Role</label>
                    <select required name="update-company_type" id="update-company_type" tabindex="1">
                        <option title='Select' value="0">user</option>
                        <option title='freelancer' value='1'>admin</option>
                    </select>
                </div>

                <div class="row">
                    <div class="col-sm-6 col-sm-offset-3">
                        <div style="margin-bottom: 10px; display: none;text-align: center" class="alert_user"></div>
                        <input type="submit" name="register-update" id="register-update"
                            class="form-control btn btn-login" value="Modifier">
                    </div>
                </div>
            </form>
        </div>
        <table id="user-table" class="display:none" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prenom</th>
                    <th>Email</th>
                    <th>Qualification</th>
                    <th></th>


                </tr>
            </thead>
        </table>
        <div class="no_data_found"></div>
    </div>
</div>





<script>



    $(document).ready(function () {
        $(document).on("submit", "#register-form", function () {
            const name = $(this).find('input[name="name"]').val().trim();
            const last_name = $(this).find('input[name="last_name"]').val().trim();
            const email = $(this).find('input[name="email"]').val().trim();
            const password = $(this).find('input[name="password"]').val().trim();
            const confirm_password = $(this).find('input[name="confirm_password"]').val().trim();
            const qualification = $(this).find('input[name="qualification"]').val().trim();
            const company_type = $(this).find('select[name="company_type"]').val();

            if (!name.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }
            else if (!last_name.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("last name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }
            else if (!password.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Password cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }
            else if (!confirm_password.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Confirm Password cannot left blank").show(0).delay(3000).hide(0);
                return false;
            }
            else if (!qualification.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Company Name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }

            else if (parseInt(company_type) === 0) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Please select a Company Type").show(0).delay(3000).hide(0);
                return false;
            }

            if (password !== confirm_password) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Passwords don't match").show(0).delay(3000).hide(0);
                return false;
            }


            let detailJSON = { name, last_name, password, confirmPassword: confirm_password, qualification, type_id: company_type };
            if (email.length) {
                detailJSON = { ...detailJSON, email }
            }

            detailJSON = JSON.stringify(detailJSON);


            $.ajax({
                url: `${api_url}/user/register`,
                type: 'post',
                data: detailJSON,
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    if (jqXHR.status === 200 && data.status === "success") {
                        $('#register-form').trigger("reset");
                        $('.register_alert_div').removeClass('alert-danger').addClass('alert-success');
                        $(".register_alert_div").html("Registered successfully. Please login <a href='/login'>here</a>").show(0);
                        getUsers();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $(".register_alert_div").empty().hide().removeClass('alert-success').addClass('alert-danger');
                    if (jqXHR.hasOwnProperty('responseJSON') && jqXHR.responseJSON.hasOwnProperty('message')) {
                        $(".register_alert_div").text(jqXHR.responseJSON.message).show().fadeTo(2000, 500).slideUp(500);
                    }
                    else {
                        $(".register_alert_div").text("Error while registering. Please try after some time !!").show().fadeTo(2000, 500).slideUp(500);
                    }
                }
            });
            return false;
        });
        $(document).on("submit", "#update-form", function () {
            const name = $(this).find('input[name="update-name"]').val().trim();
            const last_name = $(this).find('input[name="update-last_name"]').val().trim();
            const email = $(this).find('input[name="update-email"]').val().trim();


            const qualification = $(this).find('input[name="update-qualification"]').val().trim();
            const company_type = $(this).find('select[name="update-company_type"]').val();




            console.log('name', name);

            if (!name.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }
            else if (!last_name.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("last name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }

            else if (!qualification.length) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Company Name cannot be left blank").show(0).delay(3000).hide(0);
                return false;
            }

            else if (parseInt(company_type) === 0) {
                $('.register_alert_div').addClass('alert-danger');
                $(".register_alert_div").text("Please select a Company Type").show(0).delay(3000).hide(0);
                return false;
            }



            let detailJSON = { id: selectedUserId, name, last_name, qualification, type_id: company_type };
            if (email.length) {
                detailJSON = { ...detailJSON, email }
            }

            detailJSON = JSON.stringify(detailJSON);


            $.ajax({
                url: `${api_url}/user/register/update`,
                type: 'post',
                data: detailJSON,
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    if (jqXHR.status === 200 && data.status === "success") {

                        $('#update-form').trigger("reset");
                        $('.register_alert_div').removeClass('alert-danger').addClass('alert-success');
                        $(".register_alert_div").html("Registered successfully. Please login <a href='/login'>here</a>").show(0);
                        getUsers();

                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $(".register_alert_div").empty().hide().removeClass('alert-success').addClass('alert-danger');
                    if (jqXHR.hasOwnProperty('responseJSON') && jqXHR.responseJSON.hasOwnProperty('message')) {
                        $(".register_alert_div").text(jqXHR.responseJSON.message).show().fadeTo(2000, 500).slideUp(500);
                    }
                    else {
                        $(".register_alert_div").text("Error while registering. Please try after some time !!").show().fadeTo(2000, 500).slideUp(500);
                    }
                }
            });
            return false;
        });















        $(document).on('click', ".add_new_user", function () {
            $('.add-register-form').show();
            $('.remove_new_user').show();
            $('.add_new_user').hide();
            $('.update-register-form').hide();
        })

        $(document).on('click', ".remove_new_user", function () {
            $('.add-register-form').hide();
            $('.add-register-form').trigger("reset");
            $('.remove_new_user').hide();
            $('.add_new_user').show();
            $('.update-register-form').hide();
        })



        var selectedUserId;
        $(document).on('click', ".modifier_user", function () {

            var table = $('#user-table').DataTable();


            var rowData = table.row($(this).parents('tr')).data();


            selectedUserId = rowData.id;

            $('.add-register-form').hide();
            $('.remove_new_user').show();
            $('.add_new_user').hide();
            $('#update-form').find('input[name="update-name"]').val(rowData.name);
            $('#update-form').find('input[name="update-last_name"]').val(rowData.last_name);
            $('#update-form').find('input[name="update-email"]').val(rowData.email);
            $('#update-form').find('input[name="update-qualification"]').val(rowData.qualification);
            $('#update-form').find('select[name="update-company_type"]').val(rowData.type_id);

            $('.update-register-form').show();




            console.log('Selected User ID:', selectedUserId);

        })




        getUsers();
        function getUsers() {
            $.ajax({
                url: `${api_url}/user/register/all`,
                type: 'get',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", auth);
                },
                contentType: 'application/json',
                success: function (data, textStatus, jqXHR) {
                    if (jqXHR.status === 200) {
                        $('#user-table').dataTable({
                            data: data.data,
                            destroy: true,
                            columns: [
                                { data: 'name' },
                                { data: 'last_name' },
                                { data: 'email' },
                                { data: 'qualification' },
                                {
                                    // Add a column for the button
                                    targets: -1,
                                    data: null,
                                    defaultContent: '<button class="modifier_user">Modifier</button>'

                                }


                            ],
                            responsive: true
                        });
                        $('.no_data_found').hide();
                        $('#user-table').show();
                    }
                    else if (jqXHR.status === 204) {
                        $('#user-table').hide();
                        $('.no_data_found').html('<h3 class="m-t-15">No collaborateur Found</h3>');
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR.responseJSON);
                    $('#user-table').hide();
                    $('.no_data_found').html('<h3 class="m-t-15">No collaborateur Found</h3>');
                }
            });
            return false;
        }


    });



















</script>